CREATE OR REPLACE TRIGGER SQA_TRG_INC_TGFCAB_IMOBILIZADO BEFORE
    INSERT ON TGFCAB
    FOR EACH ROW
DECLARE
    PRAGMA AUTONOMOUS_TRANSACTION;
    P_VERIFICA INT; 
    
    ERROR EXCEPTION;
    ERRMSG  VARCHAR2(255);
BEGIN

 /* TRIGGER CRIADA PARA VERIFICAR SE PROJETO ESTÁ PREENCHIDO
 CRIADA POR AYRES RODRIGUES - SQA 19/04/2022 */


    IF STP_GET_ATUALIZANDO THEN
        RETURN;
    END IF;
    
    SELECT COUNT(*) INTO P_VERIFICA
    FROM TGFCAB CAB INNER JOIN
        TGFNAT NAT ON CAB.CODNAT = NAT.CODNAT
    WHERE CAB.CODPROJ = 0 
            AND NAT.CODNAT = 99050108
            AND CAB.TIPMOV = 'O'
            AND CAB.NUNOTA = :NEW.NUNOTA;

    IF ( P_VERIFICA >= 1 ) THEN
        RAISE_APPLICATION_ERROR(-20000, 'Não é inserir pedido de natureza de "IMOBILIZADO EM ANDAMENTO" sem informar Projeto.');
    END IF;
END;
/
