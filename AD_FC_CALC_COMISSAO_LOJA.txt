CREATE OR REPLACE FUNCTION SANKHYA.AD_FC_CALC_COMISSAO_LOJA (P_ITENUNOTA INT, P_ITESEQUENCIA INT, P_ITEQTDNEG INT, P_CODPROD INT, P_ITEDESCONTO FLOAT)
RETURN FLOAT AS PRAGMA AUTONOMOUS_TRANSACTION;

BEGIN

DECLARE

V_ITENUNOTA  INT := 0;
V_ITESEQUENCIA INT := 0;
V_TIPOCOMISSAO VARCHAR2(4000) := 'NULO';
V_QTDNEG FLOAT := 0;
V_CODPROD INT := 0;
V_DTNEG DATE := NULL;
V_COMISSAODESCPROM FLOAT := -1;
V_COMISSAOPROD FLOAT := -1;
V_COMISSAO FLOAT := 0;
V_DESCPROM INT := 0;
V_FAIXADESCPROM FLOAT :=0.0;
V_PERCCOMPRODLOJA FLOAT :=-1;
V_TELEVENDAS INT :=0;
V_CONTATO_COM_DIF INT :=0;
V_PERCCOM_COM_DIF FLOAT :=-1;



    BEGIN

        --BUSCA PELA DATA DE NEGOCIAÇÃO DA NOTA
        SELECT CAB.DTNEG INTO V_DTNEG 
        FROM TGFCAB CAB 
        WHERE CAB.NUNOTA = P_ITENUNOTA;

        --BUSCA SE EXISTE DESCONTO PROMOCIONAL
        SELECT COUNT(1) INTO V_DESCPROM 
        FROM TGFDES DES
        WHERE DES.CODPROD = P_CODPROD AND 
        DTINICIAL <= V_DTNEG AND DTFINAL >= V_DTNEG;

        IF V_DESCPROM > 0 THEN
                --BUSCA FAIXA DE QUANTIDADE DE DESCONTO PROMOCIONAL PARA O ITEM EM QUESTÃO
                SELECT NVL(MIN(DPQ.QTDE),0) INTO V_FAIXADESCPROM
                FROM AD_TGFDPQCOM DPQ
                LEFT JOIN AD_TGFDESCOM DESCOM ON DESCOM.CODDESCOM = DPQ.CODDESCOM
                WHERE DPQ.QTDE >= P_ITEQTDNEG AND
                DESCOM.NUPROMOCAO IN (SELECT NUPROMOCAO FROM TGFDES WHERE CODPROD = P_CODPROD AND DTINICIAL <= V_DTNEG AND DTFINAL >= V_DTNEG);

                --SE ENCONTRAR FAIXA DE DESCONTO PARA O ITEM CALCULA A COMISSÃO VINDA DO CAMPO PERCCOM DA TABELA AD_TGFDPQCOM
                IF V_FAIXADESCPROM > 0 THEN
                    SELECT NVL((SELECT NVL(DPQ.PERCCOM,-1) 
                    FROM AD_TGFDPQCOM DPQ
                    LEFT JOIN AD_TGFDESCOM DESCOM ON DESCOM.CODDESCOM = DPQ.CODDESCOM
                    WHERE DPQ.QTDE = V_FAIXADESCPROM AND
                    DESCOM.NUPROMOCAO IN (SELECT NUPROMOCAO FROM TGFDES WHERE CODPROD = P_CODPROD AND DTINICIAL <= V_DTNEG AND DTFINAL >= V_DTNEG)),-1) INTO V_COMISSAODESCPROM
                    FROM DUAL;    
                ELSE
                    V_COMISSAODESCPROM := -1;
                END IF;
        END IF;


        --BUSCA PERCENTUAL DE COMISSÃO VINDO DA TABELA DO GRUPO DE COMISSAO DE ACORDO COM O PERCENTUAL DE DESCONTO DADO AO PRODUTO
        SELECT NVL((SELECT GRUCOMFAI.PERCCOM
        FROM AD_TGFGRUCOMFAIXA GRUCOMFAI 
        WHERE GRUCOMFAI.PERCINICIAL <= P_ITEDESCONTO AND
              GRUCOMFAI.PERCFINAL >= P_ITEDESCONTO AND
              GRUCOMFAI.CODGRUCOM IN 
                (SELECT A.AD_CODGRUCOM FROM TGFPRO A WHERE A.CODPROD = P_CODPROD)),-1) INTO V_PERCCOMPRODLOJA
        FROM DUAL;

        --RAISE_APPLICATION_ERROR(-20000, 'V_PERCCOMPRODLOJA = ' || V_PERCCOMPRODLOJA);

/*
        --BUSCA A COMISSÃO DO PRODUTO
        SELECT NVL(PRO.COMVEND,-1) INTO V_COMISSAOPROD
        FROM TGFPRO PRO
        WHERE PRO.CODPROD = P_CODPROD;   
*/

        -- VERIFICA SE ITEM TEM COMISSAO DIFERENCIADA   
        SELECT 
            COUNT(1) INTO V_CONTATO_COM_DIF
        FROM 
            AD_TGFCOMDIFAGRO
        WHERE 
            NUNOTA = P_ITENUNOTA AND 
            SEQUENCIA = P_ITESEQUENCIA;
/*
        IF V_COMISSAOPROD >= 0 THEN
            V_COMISSAO := V_COMISSAOPROD;
        END IF;
*/
        IF V_PERCCOMPRODLOJA >= 0 THEN
            V_COMISSAO := V_PERCCOMPRODLOJA;
        END IF;

       IF V_COMISSAODESCPROM >= 0 THEN
            V_COMISSAO := V_COMISSAODESCPROM;
       END IF;

       IF V_CONTATO_COM_DIF > 0 THEN
            -- RECEBE COMISSAO DIFERENCIADA DO ITEM
            SELECT 
                NVL(PERCCOM,0) INTO V_PERCCOM_COM_DIF
            FROM 
                AD_TGFCOMDIFAGRO
            WHERE 
                NUNOTA = P_ITENUNOTA AND 
                SEQUENCIA = P_ITESEQUENCIA AND
                ROWNUM = 1
            ORDER BY CODCOM DESC;

            V_COMISSAO := V_PERCCOM_COM_DIF;
        END IF;

    RETURN V_COMISSAO;
 END;
END;
/